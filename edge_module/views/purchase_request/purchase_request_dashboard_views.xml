<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Tree View -->
    <record id="view_purchase_request_dashboard_tree" model="ir.ui.view">
        <field name="name">purchase.request.dashboard.tree</field>
        <field name="model">purchase.request.dashboard</field>
        <field name="arch" type="xml">
            <tree string="PR Efficiency">
                <field name="month_name"/>
                <field name="year"/>
                <field name="pr_count"/>
                <field name="draft_time" widget="float_time"/>
                <field name="validation_time" widget="float_time"/>
                <field name="approval_time" widget="float_time"/>
                <field name="po_creation_time" widget="float_time"/>
                <field name="total_time" widget="float_time"/>
            </tree>
        </field>
    </record>

    <!-- Graph View -->
    <record id="view_purchase_request_dashboard_graph" model="ir.ui.view">
        <field name="name">purchase.request.dashboard.graph</field>
        <field name="model">purchase.request.dashboard</field>
        <field name="arch" type="xml">
            <graph string="PR Efficiency" type="bar" stacked="False">
                <field name="month_name" type="row"/>
                <field name="draft_time" type="measure" string="Draft Time"/>
                <field name="validation_time" type="measure" string="Validation Time"/>
                <field name="approval_time" type="measure" string="Approval Time"/>
                <field name="po_creation_time" type="measure" string="PO Creation Time"/>
            </graph>
        </field>
    </record>

    <!-- Form View (optional but useful for details) -->
    <record id="view_purchase_request_dashboard_form" model="ir.ui.view">
        <field name="name">purchase.request.dashboard.form</field>
        <field name="model">purchase.request.dashboard</field>
        <field name="arch" type="xml">
            <form string="PR Efficiency">
                <sheet>
                    <group>
                        <group>
                            <field name="month_year"/>
                            <field name="pr_count"/>
                        </group>
                        <group>
                            <field name="draft_time" widget="float_time"/>
                            <field name="validation_time" widget="float_time"/>
                            <field name="approval_time" widget="float_time"/>
                            <field name="po_creation_time" widget="float_time"/>
                            <field name="total_time" widget="float_time"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_purchase_request_dashboard_search" model="ir.ui.view">
        <field name="name">purchase.request.dashboard.search</field>
        <field name="model">purchase.request.dashboard</field>
        <field name="arch" type="xml">
            <search string="PR Efficiency">
                <field name="month"/>
                <field name="year"/>
                <filter string="Current Year" name="current_year" domain="[('year', '=', time.strftime('%Y'))]"/>
                <filter string="Previous Year" name="prev_year" domain="[('year', '=', (context_today() - relativedelta(years=1)).strftime('%Y'))]"/>
                <separator/>
                <filter string="January" name="january" domain="[('month', '=', '01')]"/>
                <filter string="February" name="february" domain="[('month', '=', '02')]"/>
                <filter string="March" name="march" domain="[('month', '=', '03')]"/>
                <filter string="April" name="april" domain="[('month', '=', '04')]"/>
                <filter string="May" name="may" domain="[('month', '=', '05')]"/>
                <filter string="June" name="june" domain="[('month', '=', '06')]"/>
                <filter string="July" name="july" domain="[('month', '=', '07')]"/>
                <filter string="August" name="august" domain="[('month', '=', '08')]"/>
                <filter string="September" name="september" domain="[('month', '=', '09')]"/>
                <filter string="October" name="october" domain="[('month', '=', '10')]"/>
                <filter string="November" name="november" domain="[('month', '=', '11')]"/>
                <filter string="December" name="december" domain="[('month', '=', '12')]"/>
                <group expand="1" string="Group By">
                    <filter string="Month" name="group_by_month" context="{'group_by': 'month'}"/>
                    <filter string="Year" name="group_by_year" context="{'group_by': 'year'}"/>
                    <filter string="Month-Year" name="group_by_month_year" context="{'group_by': 'month_year'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action for Graph View -->
    <record id="action_purchase_request_efficiency_graph" model="ir.actions.act_window">
        <field name="name">PR Efficiency Graph</field>
        <field name="res_model">purchase.request.dashboard</field>
        <field name="view_mode">graph,tree,form</field>
        <field name="context">{'search_default_current_year': 1, 'graph_measure': ['draft_time', 'validation_time', 'approval_time', 'po_creation_time']}</field>
        <field name="search_view_id" ref="view_purchase_request_dashboard_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                This graph shows the average time PRs spend in each state by month.
            </p>
            <p>
                The graph displays:
                <ul>
                    <li>Draft Time: Time from creation to submission</li>
                    <li>Validation Time: Time from submission to validation</li>
                    <li>Approval Time: Time from validation to approval</li>
                    <li>PO Creation Time: Time from approval to PO creation</li>
                </ul>
            </p>
        </field>
    </record>

    <!-- Action for List View -->
    <record id="action_purchase_request_efficiency_list" model="ir.actions.act_window">
        <field name="name">PR Efficiency Data</field>
        <field name="res_model">purchase.request.dashboard</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="view_purchase_request_dashboard_tree"/>
        <field name="search_view_id" ref="view_purchase_request_dashboard_search"/>
        <field name="context">{'search_default_current_year': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                This view shows detailed time metrics for completed PRs by month.
            </p>
        </field>
    </record>

    <!-- Parent Menu for Reports -->
    <menuitem id="menu_purchase_request_reports"
              name="Reports"
              parent="menu_purchase_request_root"
              sequence="20"/>

    <!-- Single Menu Item for PR Efficiency (consolidating both views) -->
    <menuitem id="menu_purchase_request_efficiency"
              name="PR Efficiency"
              parent="menu_purchase_request_reports"
              action="action_purchase_request_efficiency_graph"
              sequence="10"
              groups="purchase.group_purchase_user"/>

    <!-- Add Dashboard button to PR form view -->
    <record id="view_purchase_request_form_dashboard_button" model="ir.ui.view">
        <field name="name">purchase.request.form.dashboard.button</field>
        <field name="model">purchase.request</field>
        <field name="inherit_id" ref="view_purchase_request_form"/>
        <field name="arch" type="xml">
            <xpath expr="//header" position="inside">
                <button string="Efficiency Reports" 
                        name="%(action_purchase_request_efficiency_graph)d" 
                        type="action" 
                        class="btn-secondary"
                        groups="purchase.group_purchase_user"/>
            </xpath>
        </field>
    </record>
</odoo>